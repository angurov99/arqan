<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Арқан Тартыс: Информатика</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Rope Transition */
        #rope-assembly {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .player-svg {
            overflow: visible;
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center z-20 relative shrink-0">
        <h1 class="text-xl md:text-2xl font-black tracking-tight text-gray-800 uppercase flex items-center gap-2">
            АРҚАН ТАРТЫС <span class="text-blue-600">•</span> ИНФОРМАТИКА
        </h1>
        <div class="flex items-center gap-4">
            <span id="current-set-name-display" class="text-sm font-medium bg-gray-100 px-3 py-1 rounded-full text-gray-600 hidden sm:inline-block">
                Жүктелуде...
            </span>
            <button onclick="toggleTeacherPanel()" class="flex items-center gap-2 px-4 py-2 rounded font-bold text-sm transition-colors border bg-white text-gray-600 border-gray-300 hover:bg-gray-50">
                <!-- Settings Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                Мұғалім режимі
            </button>
        </div>
    </header>

    <!-- GAME VISUALS AREA -->
    <div class="relative w-full h-64 bg-gray-50 border-y border-gray-200 overflow-hidden flex items-center justify-center shrink-0">
        <!-- Static Ground -->
        <div class="absolute bottom-10 w-full h-1 bg-gray-300"></div>
        <!-- Center Line -->
        <div class="absolute h-full w-0.5 bg-gray-300 border-dashed border-l-2 z-0"></div>
        <div class="absolute top-4 bg-gray-800 text-white text-xs px-2 py-1 rounded z-10 font-bold tracking-wider">START</div>

        <!-- MOVING CONTAINER (Players + Rope) -->
        <div id="rope-assembly" class="flex items-center justify-center relative z-10 transform translate-x-0">
            <!-- TEAM 1 (Left - Blue) -->
            <div id="team1-players" class="flex space-x-[-15px] mr-2">
                <!-- Players injected via JS -->
            </div>

            <!-- ROPE -->
            <div class="relative w-96 h-3 bg-amber-800 rounded flex items-center justify-center shadow-sm">
                <div class="absolute w-full h-full opacity-30" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #000 5px, #000 6px)"></div>
                <!-- Center Flag -->
                <div class="w-4 h-12 bg-red-600 border-2 border-white shadow-md absolute -top-4"></div>
            </div>

            <!-- TEAM 2 (Right - Red) -->
            <div id="team2-players" class="flex space-x-[-15px] ml-2 flex-row-reverse">
                <!-- Players injected via JS -->
            </div>
        </div>
    </div>

    <!-- MAIN GAMEPLAY AREA -->
    <div class="flex-1 flex flex-col md:flex-row relative">
        
        <!-- TEAM 1 PANEL -->
        <div class="flex-1 bg-blue-600 p-6 flex flex-col justify-center items-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-blue-700"></div>
            <h2 class="text-white text-2xl font-black mb-6 bg-blue-800/30 px-6 py-2 rounded-full backdrop-blur-sm">1-КОМАНДА</h2>
            
            <div class="w-full max-w-lg bg-white/10 backdrop-blur-md rounded-xl p-8 border border-white/20 shadow-xl min-h-[300px] flex flex-col">
                <div class="flex-1 flex items-center justify-center text-center">
                    <p id="q-team1-text" class="text-2xl font-bold text-white leading-relaxed drop-shadow-md">
                        Сұрақ жүктелуде...
                    </p>
                </div>

                <div class="mt-8 space-y-4">
                    <div class="relative">
                        <input id="input-team1" type="text" placeholder="Жауапты осында жазыңыз..." autocomplete="off"
                            class="w-full p-4 rounded-lg bg-black/20 border-2 border-white/30 text-white placeholder-blue-200 focus:outline-none focus:border-white focus:bg-black/30 transition-all text-lg font-medium">
                        <div id="msg-team1" class="absolute -top-10 left-0 right-0 text-center font-bold text-lg opacity-0 transition-opacity duration-300"></div>
                    </div>
                    <button onclick="handleAnswer('team1')" id="btn-team1"
                        class="w-full bg-white text-blue-600 font-black py-4 rounded-lg hover:bg-blue-50 active:scale-95 transition-all shadow-lg text-xl uppercase tracking-wider">
                        ЖАУАП БЕРУ
                    </button>
                </div>
            </div>
        </div>

        <!-- TEAM 2 PANEL -->
        <div class="flex-1 bg-red-600 p-6 flex flex-col justify-center items-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-red-700"></div>
            <h2 class="text-white text-2xl font-black mb-6 bg-red-800/30 px-6 py-2 rounded-full backdrop-blur-sm">2-КОМАНДА</h2>
            
            <div class="w-full max-w-lg bg-white/10 backdrop-blur-md rounded-xl p-8 border border-white/20 shadow-xl min-h-[300px] flex flex-col">
                <div class="flex-1 flex items-center justify-center text-center">
                    <p id="q-team2-text" class="text-2xl font-bold text-white leading-relaxed drop-shadow-md">
                        Сұрақ жүктелуде...
                    </p>
                </div>

                <div class="mt-8 space-y-4">
                    <div class="relative">
                        <input id="input-team2" type="text" placeholder="Жауапты осында жазыңыз..." autocomplete="off"
                            class="w-full p-4 rounded-lg bg-black/20 border-2 border-white/30 text-white placeholder-red-200 focus:outline-none focus:border-white focus:bg-black/30 transition-all text-lg font-medium">
                        <div id="msg-team2" class="absolute -top-10 left-0 right-0 text-center font-bold text-lg opacity-0 transition-opacity duration-300"></div>
                    </div>
                    <button onclick="handleAnswer('team2')" id="btn-team2"
                        class="w-full bg-white text-red-600 font-black py-4 rounded-lg hover:bg-red-50 active:scale-95 transition-all shadow-lg text-xl uppercase tracking-wider">
                        ЖАУАП БЕРУ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WINNER OVERLAY -->
    <div id="winner-overlay" class="fixed inset-0 z-40 bg-black/80 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white p-12 rounded-3xl shadow-2xl text-center max-w-2xl transform scale-110 animate-fade-in">
            <!-- Trophy Icon -->
            <div id="winner-icon" class="mx-auto mb-6 text-yellow-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            </div>
            <h2 id="winner-text" class="text-5xl font-black mb-4 uppercase"></h2>
            <p class="text-gray-500 mb-8 text-xl">Құттықтаймыз!</p>
            <button onclick="resetGame()" class="bg-gray-900 text-white text-xl font-bold py-4 px-10 rounded-full hover:bg-gray-800 transition-colors flex items-center gap-3 mx-auto shadow-xl hover:shadow-2xl">
                <!-- Refresh Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                Қайта ойнау
            </button>
        </div>
    </div>

    <!-- TEACHER PANEL -->
    <div id="teacher-panel" class="fixed inset-0 bg-black/50 z-50 flex justify-end hidden">
        <div class="w-full max-w-md bg-white h-full shadow-2xl flex flex-col animate-slide-in-right">
            <!-- Panel Header -->
            <div class="p-4 bg-gray-800 text-white flex justify-between items-center shadow-md">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    Мұғалім панелі
                </h2>
                <button onclick="toggleTeacherPanel()" class="hover:bg-gray-700 p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                
                <!-- Section Management -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-900 mb-3 uppercase text-sm tracking-wider">Сабақтар / Кластар</h3>
                    
                    <div id="set-controls-view" class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Қазіргі бөлім:</label>
                            <select id="sets-dropdown" onchange="changeSet(this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showCreateSetUI()" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded flex items-center justify-center gap-1 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Жаңа бөлім
                            </button>
                            <button id="delete-set-btn" onclick="deleteCurrentSet()" class="bg-red-100 hover:bg-red-200 text-red-700 p-2 rounded transition-colors" title="Бөлімді жою">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div id="create-set-view" class="space-y-3 hidden animate-fade-in">
                        <label class="block text-sm font-medium text-gray-700">Бөлім атауы:</label>
                        <input id="new-set-name" type="text" placeholder="Мысалы: 5-сынып" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                        <div class="flex gap-2">
                            <button onclick="createSet()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-1 rounded">Құру</button>
                            <button onclick="hideCreateSetUI()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-1 rounded">Болдырмау</button>
                        </div>
                    </div>
                </div>

                <!-- Question Editor -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-800 uppercase text-sm tracking-wider">Сұрақтар редакторы</h3>
                        <span id="question-count" class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">0 сұрақ</span>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm mb-4">
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Сұрақ (информатика):</label>
                            <textarea id="new-q-text" class="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none text-sm" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Дұрыс жауап:</label>
                            <input id="new-q-answer" type="text" class="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none text-sm">
                        </div>
                        <button onclick="addQuestion()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded flex items-center justify-center gap-2 transition-colors font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Сұрақты қосу
                        </button>
                    </div>

                    <!-- Questions List -->
                    <div id="questions-list" class="space-y-2">
                        <!-- Questions injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- CONSTANTS ---
        const STORAGE_KEY = 'arkan_tartys_data_v2';
        const WINNING_SCORE = 5;
        const DEFAULT_QUESTIONS = {
            id: 'default-set',
            name: 'Жалпы сұрақтар (Мысал)',
            questions: [
                { id: '1', text: '1 байтта неше бит бар?', answer: '8' },
                { id: '2', text: 'Ақпаратты өңдейтін негізгі құрылғы?', answer: 'процессор' },
                { id: '3', text: 'Компьютердің "миы" қалай аталады?', answer: 'процессор' },
                { id: '4', text: 'Мәтіндік ақпаратты сақтайтын файл кеңейтілуі?', answer: 'txt' },
                { id: '5', text: 'Интернеттегі парақшаларды қарауға арналған бағдарлама?', answer: 'браузер' }
            ]
        };

        // --- STATE ---
        let sets = {};
        let currentSetId = '';
        let gameState = {
            ropePosition: 0, // -5 to +5
            winner: null
        };
        let qTeam1 = null;
        let qTeam2 = null;

        // --- INITIALIZATION ---
        function init() {
            loadData();
            renderGameVisuals();
            renderTeamPlayers(); // Render the SVGs once
            
            // Listen for enter keys
            document.getElementById('input-team1').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') handleAnswer('team1');
            });
            document.getElementById('input-team2').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') handleAnswer('team2');
            });

            // Start game
            if(sets[currentSetId] && sets[currentSetId].questions.length > 0) {
                resetGame();
            } else {
                updateUIQuestions();
            }
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    sets = parsed.sets || {};
                    currentSetId = parsed.currentSetId || '';
                    
                    // Fallback if data is corrupted/empty
                    if (Object.keys(sets).length === 0) {
                        sets = { [DEFAULT_QUESTIONS.id]: JSON.parse(JSON.stringify(DEFAULT_QUESTIONS)) };
                        currentSetId = DEFAULT_QUESTIONS.id;
                    }
                    // Ensure currentSetId is valid
                    if (!sets[currentSetId]) {
                         currentSetId = Object.keys(sets)[0];
                    }
                } catch (e) {
                    console.error("Error loading data", e);
                    resetToDefault();
                }
            } else {
                resetToDefault();
            }
        }

        function resetToDefault() {
            sets = { [DEFAULT_QUESTIONS.id]: JSON.parse(JSON.stringify(DEFAULT_QUESTIONS)) };
            currentSetId = DEFAULT_QUESTIONS.id;
            saveData();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ sets, currentSetId }));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // --- GAME LOGIC ---

        function getRandomQuestion(excludeId) {
            if (!sets[currentSetId]) return null;
            const allQs = sets[currentSetId].questions;
            if (allQs.length === 0) return null;
            
            const available = allQs.filter(q => q.id !== excludeId);
            if (available.length === 0) return allQs[0];
            
            const idx = Math.floor(Math.random() * available.length);
            return available[idx];
        }

        function resetGame() {
            gameState.ropePosition = 0;
            gameState.winner = null;
            
            qTeam1 = getRandomQuestion();
            qTeam2 = getRandomQuestion();
            
            // Clear inputs
            document.getElementById('input-team1').value = '';
            document.getElementById('input-team2').value = '';
            document.getElementById('input-team1').disabled = false;
            document.getElementById('input-team2').disabled = false;
            document.getElementById('btn-team1').disabled = false;
            document.getElementById('btn-team2').disabled = false;

            // Hide winner overlay
            document.getElementById('winner-overlay').classList.add('hidden');

            renderGameVisuals();
            updateUIQuestions();
        }

        function handleAnswer(team) {
            if (gameState.winner) return;

            const inputEl = document.getElementById(`input-${team}`);
            const inputVal = inputEl.value.trim().toLowerCase();
            const question = team === 'team1' ? qTeam1 : qTeam2;

            if (!question) return;

            if (inputVal === question.answer.toLowerCase()) {
                // Correct Answer
                showFeedback(team, 'Дұрыс!', 'success');
                inputEl.value = '';
                
                // Move rope
                // Team 1 (Left) correct => Rope moves Left (Negative X)
                // Team 2 (Right) correct => Rope moves Right (Positive X)
                const move = team === 'team1' ? -1 : 1;
                gameState.ropePosition += move;

                // Check Win
                if (gameState.ropePosition <= -WINNING_SCORE) endGame('team1');
                else if (gameState.ropePosition >= WINNING_SCORE) endGame('team2');
                else {
                    // Update visuals and get new question
                    renderGameVisuals();
                    if (team === 'team1') qTeam1 = getRandomQuestion(qTeam1.id);
                    else qTeam2 = getRandomQuestion(qTeam2.id);
                    updateUIQuestions();
                }

            } else {
                // Wrong Answer
                showFeedback(team, 'Қате жауап', 'error');
            }
        }

        function showFeedback(team, text, type) {
            const msgEl = document.getElementById(`msg-${team}`);
            msgEl.textContent = text;
            msgEl.className = `absolute -top-10 left-0 right-0 text-center font-bold text-lg transition-opacity duration-300 ${type === 'success' ? 'text-green-300' : 'text-yellow-300'}`;
            msgEl.style.opacity = '1';
            
            setTimeout(() => {
                msgEl.style.opacity = '0';
            }, 1500);
        }

        function endGame(winner) {
            gameState.winner = winner;
            renderGameVisuals();
            
            // Disable inputs
            document.getElementById('input-team1').disabled = true;
            document.getElementById('input-team2').disabled = true;
            document.getElementById('btn-team1').disabled = true;
            document.getElementById('btn-team2').disabled = true;

            // Show Overlay
            const overlay = document.getElementById('winner-overlay');
            const wText = document.getElementById('winner-text');
            const wIcon = document.getElementById('winner-icon');
            
            wText.textContent = winner === 'team1' ? '1-КОМАНДА ЖЕҢДІ!' : '2-КОМАНДА ЖЕҢДІ!';
            wText.className = `text-5xl font-black mb-4 uppercase ${winner === 'team1' ? 'text-blue-600' : 'text-red-600'}`;
            wIcon.className = `mx-auto mb-6 ${winner === 'team1' ? 'text-blue-600' : 'text-red-600'}`;

            setTimeout(() => {
                overlay.classList.remove('hidden');
                triggerConfetti(winner);
            }, 500);
        }

        function triggerConfetti(winner) {
            const colors = winner === 'team1' ? ['#2563EB', '#ffffff'] : ['#DC2626', '#ffffff'];
            const originX = winner === 'team1' ? 0 : 1;
            
            const duration = 3000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: winner === 'team1' ? 60 : 120,
                    spread: 55,
                    origin: { x: originX },
                    colors: colors
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        // --- RENDERING VISUALS ---

        function getPlayerSVG(team, isPulling) {
            const isBlue = team === 'team1';
            const colorPrimary = isBlue ? '#2563EB' : '#DC2626';
            const colorDark = isBlue ? '#1E40AF' : '#991B1B';
            const rotation = isPulling ? (isBlue ? -15 : 15) : 0;

            // Using template literal for SVG string
            return `
            <svg class="player-svg" width="60" height="100" viewBox="0 0 60 100" style="transform: rotate(${rotation}deg); transition: transform 0.3s ease-out;">
                <!-- Legs -->
                <path d="M20,70 L10,100 M40,70 L50,100" stroke="#1f2937" stroke-width="8" stroke-linecap="round" />
                <!-- Body -->
                <rect x="15" y="30" width="30" height="45" rx="5" fill="${colorPrimary}" />
                <!-- Vest/Ornament -->
                <path d="M15,30 L30,50 L45,30" fill="none" stroke="white" stroke-width="3" />
                <path d="M15,75 L45,75" stroke="#FFD700" stroke-width="4" />
                <!-- Arms -->
                <path d="${isBlue ? 'M20,35 L5,50 L30,50' : 'M40,35 L55,50 L30,50'}" fill="none" stroke="${colorDark}" stroke-width="6" stroke-linecap="round" />
                <!-- Head -->
                <circle cx="30" cy="20" r="12" fill="#F3E5AB" />
                <!-- Hat -->
                ${isBlue 
                  ? `<path d="M18,14 L30,-5 L42,14 Z" fill="white" stroke="#1f2937" stroke-width="1" />` 
                  : `<path d="M16,12 Q30,-2 44,12 Z" fill="${colorDark}" stroke="#1f2937" stroke-width="1" />`
                }
                <!-- Face -->
                <circle cx="26" cy="18" r="1" fill="#000" />
                <circle cx="34" cy="18" r="1" fill="#000" />
            </svg>
            `;
        }

        function renderTeamPlayers() {
            const t1Container = document.getElementById('team1-players');
            const t2Container = document.getElementById('team2-players');
            
            // Render 3 players each side
            t1Container.innerHTML = Array(3).fill(null).map(() => getPlayerSVG('team1', true)).join('');
            t2Container.innerHTML = Array(3).fill(null).map(() => getPlayerSVG('team2', true)).join('');
        }

        function renderGameVisuals() {
            // Rope Movement
            const stepSize = 40; // px
            const xOffset = gameState.ropePosition * stepSize;
            document.getElementById('rope-assembly').style.transform = `translateX(${xOffset}px)`;
        }

        function updateUIQuestions() {
            // Update Headers
            const setName = sets[currentSetId] ? sets[currentSetId].name : 'Белгісіз';
            document.getElementById('current-set-name-display').textContent = setName;

            // Update Question Text
            const t1Text = document.getElementById('q-team1-text');
            const t2Text = document.getElementById('q-team2-text');

            if (sets[currentSetId] && sets[currentSetId].questions.length > 0) {
                t1Text.textContent = qTeam1 ? qTeam1.text : 'Сұрақ дайындалуда...';
                t2Text.textContent = qTeam2 ? qTeam2.text : 'Сұрақ дайындалуда...';
            } else {
                t1Text.textContent = 'Сұрақтар жоқ... Мұғалім сұрақ қосуы керек.';
                t2Text.textContent = 'Сұрақтар жоқ... Мұғалім сұрақ қосуы керек.';
            }
        }

        // --- TEACHER PANEL LOGIC ---

        function toggleTeacherPanel() {
            const panel = document.getElementById('teacher-panel');
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                renderTeacherPanelContent();
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        function renderTeacherPanelContent() {
            const dropdown = document.getElementById('sets-dropdown');
            dropdown.innerHTML = '';
            
            Object.values(sets).forEach(set => {
                const option = document.createElement('option');
                option.value = set.id;
                option.textContent = set.name;
                if (set.id === currentSetId) option.selected = true;
                dropdown.appendChild(option);
            });

            // Delete button visibility
            const delBtn = document.getElementById('delete-set-btn');
            delBtn.style.display = Object.keys(sets).length > 1 ? 'inline-block' : 'none';

            renderQuestionsList();
        }

        function renderQuestionsList() {
            const listEl = document.getElementById('questions-list');
            const countEl = document.getElementById('question-count');
            listEl.innerHTML = '';

            const currentSet = sets[currentSetId];
            if (!currentSet) return;

            countEl.textContent = `${currentSet.questions.length} сұрақ`;

            if (currentSet.questions.length === 0) {
                listEl.innerHTML = `<div class="text-center py-8 text-gray-400">Бұл бөлімде сұрақтар жоқ.</div>`;
                return;
            }

            currentSet.questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-start bg-gray-50 p-3 rounded border border-gray-100 group hover:border-blue-200 transition-colors';
                div.innerHTML = `
                    <div class="flex-1 pr-2">
                        <p class="text-sm font-medium text-gray-800"><span class="text-gray-400 mr-1">${idx + 1}.</span> ${q.text}</p>
                        <p class="text-xs text-green-600 mt-1 font-mono">${q.answer}</p>
                    </div>
                    <button onclick="deleteQuestion('${q.id}')" class="text-gray-400 hover:text-red-600 p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                `;
                listEl.appendChild(div);
            });
        }

        function changeSet(newId) {
            currentSetId = newId;
            saveData();
            renderTeacherPanelContent();
            resetGame(); // Reset game when set changes
        }

        function showCreateSetUI() {
            document.getElementById('set-controls-view').classList.add('hidden');
            document.getElementById('create-set-view').classList.remove('hidden');
        }

        function hideCreateSetUI() {
            document.getElementById('create-set-view').classList.add('hidden');
            document.getElementById('set-controls-view').classList.remove('hidden');
            document.getElementById('new-set-name').value = '';
        }

        function createSet() {
            const name = document.getElementById('new-set-name').value.trim();
            if (name) {
                const newId = generateId();
                sets[newId] = { id: newId, name: name, questions: [] };
                currentSetId = newId;
                saveData();
                hideCreateSetUI();
                renderTeacherPanelContent();
                resetGame();
            }
        }

        function deleteCurrentSet() {
            if (Object.keys(sets).length <= 1) return; // Should not happen due to UI check
            
            if (confirm('Бұл бөлімді жоюға сенімдісіз бе? Барлық сұрақтар өшіріледі.')) {
                delete sets[currentSetId];
                
                // Pick next available set
                currentSetId = Object.keys(sets)[0];
                saveData();
                renderTeacherPanelContent();
                resetGame();
            }
        }

        function addQuestion() {
            const textEl = document.getElementById('new-q-text');
            const ansEl = document.getElementById('new-q-answer');
            const text = textEl.value.trim();
            const answer = ansEl.value.trim();

            if (text && answer) {
                const newQ = {
                    id: generateId(),
                    text: text,
                    answer: answer
                };
                sets[currentSetId].questions.push(newQ);
                saveData();
                
                // Reset fields
                textEl.value = '';
                ansEl.value = '';
                
                renderQuestionsList();
                // If this was the first question, reset game to show it
                if (sets[currentSetId].questions.length === 1) resetGame();
            }
        }

        function deleteQuestion(qId) {
            sets[currentSetId].questions = sets[currentSetId].questions.filter(q => q.id !== qId);
            saveData();
            renderQuestionsList();
            
            // If current displayed question was deleted, refresh game
            if ((qTeam1 && qTeam1.id === qId) || (qTeam2 && qTeam2.id === qId)) {
                resetGame();
            }
        }

        // --- STARTUP ---
        init();

    </script>
</body>
</html>